stages:
  - build
  - deploy
  
.default_docker:
  image: docker:24.0.7
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY

build:
  stage: build
  extends: .default_docker
  script:
    - docker build -t "$CI_REGISTRY_IMAGE/api:$CI_COMMIT_SHORT_SHA" .
    - docker push "$CI_REGISTRY_IMAGE/api:$CI_COMMIT_SHORT_SHA"
  only:
    - main


deploy:
  stage: deploy
  script:
    - |
      # Configure Git to use the PAT
      git config --global credential.helper store
      echo "https://gitlab-ci-token:$CI_GITLAB_TOKEN@gitlab.sananetco.com" > ~/.git-credentials
      # Clone the repository using the configured credentials
      git clone https://gitlab.sananetco.com/devops-scenarios/gitops-example03-manifests.git
      cd gitops-example03-manifests
      git checkout main
      git config --global user.email "ci@mycompany.com"
      git config --global user.name "CI Bot"
      git pull origin main
      sed -i "s|image:.*|image: $IMAGE|" k8s/deployment.yaml
      git add k8s/deployment.yaml
      git commit -m "Deploy $CI_COMMIT_SHORT_SHA"
      git push origin main
  only:
    - main
  tags:
    - dind
